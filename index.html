<html lang="zh">

    <head>
        {{include header.html}}
        <title>订餐</title>

        <script>
            jsonRPC.setup({endPoint: '/api',namespace: 'public'});
            jsonRPC.request('get_user_list', {
                params: [],
                success: function(result){
                    console.log(result);
                },
                error: function(result) {
                    console.log(result);
                }
            });
            jsonRPC.request('get_last_menu_list', {
                params: [],
                success: function(result){
                    console.log(result);
                },
                error: function(result) {
                    console.log(result);
                }
            });

            function uploadfile(file, cb) {
                var reader = new FileReader();
                reader.onloadstart =  function(p) {
                    console.log("onloadstart");
                }
                reader.onprogress = function(p) {
                    console.log("onprogress");
                }
                reader.onload = function() {
                    console.log("load complete");
                }
                reader.onloadend = function()
                {
                    if (reader.error) {
                        console.log(reader.error);
                    } else {
                        //document.getElementById("bytesRead").textContent = file.size;
                        console.log(typeof(reader.result));
                        var xhr = new XMLHttpRequest();
                        xhr.onreadystatechange = function() {
                            if (xhr.readyState==4) {
                                if (xhr.status==200) {
                                    console.log("upload complete, response: "+ xhr.responseText);
                                    cb(file.name,xhr.responseText);
                                }
                            }
                        };
                        console.log(file.name);
                        xhr.open("POST","/upload?file_name="+file.name,true);
                        xhr.overrideMimeType("application/octet-stream");
                        xhr.send(reader.result);
                    }
                }
                reader.readAsBinaryString(file);
            }

            function uploadfiles(fsobj,cb) {
                console.log(fsobj);
                for (var i=0; i<fsobj.files.length; i++) {
                    var file = fsobj.files[i];
                    uploadfile(file, cb);
                }
            }

            function uploadcomplete(filename,fpath) {
                console.log("complete upload:" + filename);
                uploadfnames[uploadcompleteidx] = fpath;
                uploadcompleteidx++;
                var obj = document.getElementById('flist_'+filename);
                if (obj) {
                    obj.innerHTML = filename + '&radic;';
                }
                console.log(uploadcompleteidx,uploadfnames,uploadfnames.length);
                if (uploadcompleteidx == uploadfnames.length) {
                    jsonRPC.request('upload_menu', {
                        params: [uploadfnames],
                        success: function(result){
                            alert(result.result);
                            console.log(result);
                        },
                        error: function(result) {
                            console.log(result);
                        }
                    });
                }
            }

            function uploadImages() {
                var fileobj = document.getElementById("file");
                if (fileobj.files.length>0) {
                    uploadcompleteidx = 0;
                    uploadfnames = new Array(fileobj.files.length);
                    var fileobj = document.getElementById("file");
                    console.log(fileobj.files);
                    uploadfiles(fileobj,uploadcomplete);
                } else {
                    alert("请先选择文件");
                }
            }

            function fileselectchanged() {
                var container = document.getElementById("imglist");
                var html = "<ol>";
                var fileobj = document.getElementById("file");
                for (var i=0; i<fileobj.files.length; i++) {
                    var name = fileobj.files[i].name;
                    html += "<li id='flist_"+ name +"'>" + name + "</li>";
                    console.log(fileobj.files);
                }
                html += "</ol>";
                container.innerHTML = html;
            }
        </script>

    </head>

    <body>
        <h1>订餐系统</h1>

        <p>上传菜单: <input type="file" multiple id="file" onchange="fileselectchanged()"/>
        <input type="button" value="上传" onclick="uploadImages()" /></p> 

         <div id="imglist">
         </div> 

         <div id="menuview">
         </div>

        <footer>
        {{include footer.html}}
        </footer>
    </body>
</html>

